---
# Main playbook for complete Session Service Node deployment
# This playbook orchestrates the full deployment process:
#   0. Bootstrap (ensures admin user exists)
#   1. System preparation (common role)
#   2. Security hardening with SSH, UFW, and fail2ban (security role)
#   3. Session node installation and configuration (session-node role)
#
# Usage:
#   ansible-playbook playbooks/site.yml \
#     -e "l2_provider_url=https://..." \
#     -e "operator_eth_address=0x..."
#

# Import bootstrap playbook to ensure admin user exists
- import_playbook: bootstrap.yml

# Main deployment
- name: Deploy Session Service Nodes
  hosts: session_nodes
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "=== Session Service Node Deployment ==="
          - "Target hosts: {{ ansible_play_hosts | length }}"
          - "Operator ETH address: {{ operator_eth_address | default('NOT PROVIDED') }}"
          - "L2 Provider configured: {{ 'yes' if l2_provider_url is defined else 'NO - REQUIRED' }}"
      tags:
        - always

    - name: Validate required variables are provided
      assert:
        that:
          - l2_provider_url is defined
          - l2_provider_url | length > 0
          - operator_eth_address is defined
          - operator_eth_address | length > 0
          - operator_eth_address is match('^0x[a-fA-F0-9]{40}$')
        fail_msg: |
          Required variables missing or invalid!

          You must provide:
            -e "l2_provider_url=https://your-rpc-provider.example/v1/your-key"
            -e "operator_eth_address=0xYourEthereumAddress"

          Example:
            ansible-playbook playbooks/site.yml \
              -e "l2_provider_url=https://arb-mainnet.g.alchemy.com/v2/your-key" \
              -e "operator_eth_address=0x1234567890123456789012345678901234567890"
        success_msg: "✓ All required variables validated"
      tags:
        - always
        - validation

  roles:
    - role: common
      tags:
        - common
        - system

    - role: security
      tags:
        - security
        - hardening

    - role: session-node
      tags:
        - session
        - node

  post_tasks:
    - name: Display registration instructions
      debug:
        msg:
          - ""
          - "╔════════════════════════════════════════════════════════════════╗"
          - "║          Session Service Node Deployment Complete!            ║"
          - "╚════════════════════════════════════════════════════════════════╝"
          - ""
          - "Next Steps - Node Registration:"
          - ""
          - "For each node, you need to register it on the Session network:"
          - ""
          - "1. SSH to the node as {{ admin_user }}:"
          - "   ssh {{ admin_user }}@{{ ansible_host }}"
          - ""
          - "2. Run the registration command:"
          - "   sudo oxend register {{ operator_eth_address }}"
          - ""
          - "3. Copy the registration URL that appears (starts with https://stake.getsession.org/)"
          - ""
          - "4. Open the URL in your browser and complete the staking process"
          - "   ⚠️  IMPORTANT: You have 9-12 minutes to complete staking!"
          - ""
          - "5. Verify node status:"
          - "   sudo oxend status"
          - "   sudo oxend print_sn_status"
          - ""
          - "6. Monitor logs:"
          - "   sudo journalctl -u oxen-node -f"
          - ""
          - "Additional Information:"
          - "  - Test QUIC connectivity: https://quictest.oxen.io/"
          - "  - Session documentation: https://docs.getsession.org/"
          - "  - Node configuration: {{ oxen_config_file }}"
          - "  - Logs: sudo journalctl -u oxen-node -f"
          - ""
          - "Security Notes:"
          - "  ✓ SSH hardened (password auth disabled, root login disabled)"
          - "  ✓ UFW firewall enabled"
          - "  ✓ fail2ban monitoring SSH access"
          - "  ✓ Non-root admin user '{{ admin_user }}' created"
          - ""
      run_once: yes
      tags:
        - always

    - name: Save node details to local file
      copy:
        content: |
          # Session Service Node Deployment Details
          # Generated: {{ ansible_facts['date_time']['iso8601'] }}

          ## Nodes Deployed

          {% for host in ansible_play_hosts %}
          ### {{ host }}
          - IP Address: {{ hostvars[host].ansible_host }}
          - Public IP: {{ hostvars[host].node_public_ip }}
          - Admin User: {{ admin_user }}
          - SSH Command: ssh {{ admin_user }}@{{ hostvars[host].ansible_host }}
          - Registration Command: sudo oxend register {{ operator_eth_address }}

          {% endfor %}

          ## Configuration

          - Operator ETH Address: {{ operator_eth_address }}
          - L2 Provider: {{ l2_provider_url }}
          - Config File: {{ oxen_config_file }}
          - Data Directory: {{ oxen_data_dir }}

          ## Next Steps

          1. SSH to each node and run: sudo oxend register {{ operator_eth_address }}
          2. Complete staking at https://stake.getsession.org/ (within 9-12 minutes)
          3. Verify with: sudo oxend status && sudo oxend print_sn_status
          4. Monitor logs: sudo journalctl -u oxen-node -f
        dest: "{{ playbook_dir }}/../deployment-{{ ansible_facts['date_time']['date'] }}-{{ ansible_facts['date_time']['time'] | replace(':', '') }}.txt"
      delegate_to: localhost
      become: no
      run_once: yes
      tags:
        - always
